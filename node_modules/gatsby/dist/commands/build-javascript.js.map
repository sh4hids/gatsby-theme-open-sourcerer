{"version":3,"sources":["../../src/commands/build-javascript.ts"],"names":["buildProductionBundle","program","parentSpan","directory","compilerConfig","Promise","resolve","reject","compiler","THIRTY_SECONDS","cancelCacheNotice","process","env","gatsby_executing_command","GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE","run","err","stats","hasErrors","compilation","errors","activity","reporter","activityTimer","start","waitForCompilerClose","close","error","end"],"mappings":";;;;;;;AACA;;AACA;;AAEA;;AACA;;AAKO,MAAMA,qBAAqB,GAAG,OACnCC,OADmC,EAEnCC,UAFmC,KAM/B;AACJ,QAAM;AAAEC,IAAAA;AAAF,MAAgBF,OAAtB;AAEA,QAAMG,cAAc,GAAG,MAAM,uBAC3BH,OAD2B,EAE3BE,SAF2B,EAG1B,kBAH0B,EAI3B,IAJ2B,EAK3B;AAAED,IAAAA;AAAF,GAL2B,CAA7B;AAQA,SAAO,IAAIG,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,UAAMC,QAAQ,GAAG,sBAAQJ,cAAR,CAAjB;AAEA,UAAMK,cAAc,GAAG,KAAK,IAA5B;AACA,QAAIC,iBAAJ;;AACA,QACEC,OAAO,CAACC,GAAR,CAAYC,wBAAZ,KAA0C,OAA1C,IACA,CAACF,OAAO,CAACC,GAAR,CAAYE,0CAFf,EAGE;AACAJ,MAAAA,iBAAiB,GAAG,4DACjB,4BADiB,EAEjB,sDAFiB,EAGjB;AACT;AACA;AACA;AACA;AACA;AACA;AACA,EAV0B,EAWlBD,cAXkB,CAApB;AAaD;;AAEDD,IAAAA,QAAQ,CAACO,GAAT,CAAa,CAACC,GAAD,EAAMC,KAAN,KAAgB;AAC3B,UAAIP,iBAAJ,EAAuB;AACrBA,QAAAA,iBAAiB;AAClB,OAH0B,CAK3B;;;AACA,UAAIM,GAAG,IAAI,CAACC,KAAZ,EAAmB;AACjB,eAAOV,MAAM,CAACS,GAAD,CAAb;AACD;;AAED,UAAIC,KAAK,CAACC,SAAN,EAAJ,EAAuB;AACrB,eAAOX,MAAM,CAACU,KAAK,CAACE,WAAN,CAAkBC,MAAnB,CAAb;AACD;;AAED,UAAIC,QAAJ;;AACA,UAAIV,OAAO,CAACC,GAAR,CAAYE,0CAAhB,EAA4D;AAC1DO,QAAAA,QAAQ,GAAGC,kBAASC,aAAT,CACR,gDADQ,EAET;AAAErB,UAAAA;AAAF,SAFS,CAAX;AAIAmB,QAAAA,QAAQ,CAACG,KAAT;AACD;;AAED,YAAMC,oBAAoB,GAAG,IAAIpB,OAAJ,CAAkB,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAClEC,QAAAA,QAAQ,CAACkB,KAAT,CAAeC,KAAK,IAAI;AACtB,cAAIN,QAAJ,EAAc;AACZA,YAAAA,QAAQ,CAACO,GAAT;AACD;;AAED,cAAID,KAAJ,EAAW;AACT,mBAAOpB,MAAM,CAACoB,KAAD,CAAb;AACD;;AACD,iBAAOrB,OAAO,EAAd;AACD,SATD;AAUD,OAX4B,CAA7B;AAaA,aAAOA,OAAO,CAAC;AAAEW,QAAAA,KAAF;AAASQ,QAAAA;AAAT,OAAD,CAAd;AACD,KArCD;AAsCD,GA9DM,CAAP;AA+DD,CAhFM","sourcesContent":["import { Span } from \"opentracing\"\nimport webpack, { WebpackError } from \"webpack\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { IProgram } from \"./types\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport {\n  showExperimentNoticeAfterTimeout,\n  CancelExperimentNoticeCallbackOrUndefined,\n} from \"../utils/show-experiment-notice\"\n\nexport const buildProductionBundle = async (\n  program: IProgram,\n  parentSpan: Span\n): Promise<{\n  stats: webpack.Stats | Error | Array<WebpackError>\n  waitForCompilerClose: Promise<void>\n}> => {\n  const { directory } = program\n\n  const compilerConfig = await webpackConfig(\n    program,\n    directory,\n    `build-javascript`,\n    null,\n    { parentSpan }\n  )\n\n  return new Promise((resolve, reject) => {\n    const compiler = webpack(compilerConfig)\n\n    const THIRTY_SECONDS = 30 * 1000\n    let cancelCacheNotice: CancelExperimentNoticeCallbackOrUndefined\n    if (\n      process.env.gatsby_executing_command === `build` &&\n      !process.env.GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE\n    ) {\n      cancelCacheNotice = showExperimentNoticeAfterTimeout(\n        `Persistent webpack caching`,\n        `https://github.com/gatsbyjs/gatsby/discussions/28331`,\n        `which enables webpack's persist caching and changes Gatsby's cache clearing behavior to not clear webpack's\ncache unless you run \"gatsby clean\" or delete the .cache folder manually.\nHere's how to try it:\n\nmodule.exports = {\n  flags: { PRESERVE_WEBPACK_CACHE: true },\n  plugins: [...]\n}`,\n        THIRTY_SECONDS\n      )\n    }\n\n    compiler.run((err, stats) => {\n      if (cancelCacheNotice) {\n        cancelCacheNotice()\n      }\n\n      // stats can only be empty when an error occurs. Adding it to the if makes typescript happy.\n      if (err || !stats) {\n        return reject(err)\n      }\n\n      if (stats.hasErrors()) {\n        return reject(stats.compilation.errors)\n      }\n\n      let activity\n      if (process.env.GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE) {\n        activity = reporter.activityTimer(\n          `Caching JavaScript and CSS webpack compilation`,\n          { parentSpan }\n        )\n        activity.start()\n      }\n\n      const waitForCompilerClose = new Promise<void>((resolve, reject) => {\n        compiler.close(error => {\n          if (activity) {\n            activity.end()\n          }\n\n          if (error) {\n            return reject(error)\n          }\n          return resolve()\n        })\n      })\n\n      return resolve({ stats, waitForCompilerClose })\n    })\n  })\n}\n"],"file":"build-javascript.js"}