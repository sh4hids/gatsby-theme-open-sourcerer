{"version":3,"sources":["../../src/services/run-page-queries.ts"],"names":["ONE_MINUTE","runPageQueries","parentSpan","queryIds","store","program","graphqlRunner","state","getState","pageQueryIds","length","activity","reporter","createProgress","id","start","cancelNotice","process","env","gatsby_executing_command","GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND","graphqlTracing","NODE_ENV","done"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AACA;;AAIA;;AACA;;AAEA,MAAMA,UAAU,GAAG,IAAI,EAAJ,GAAS,IAA5B;;AAEO,eAAeC,cAAf,CAA8B;AACnCC,EAAAA,UADmC;AAEnCC,EAAAA,QAFmC;AAGnCC,EAAAA,KAHmC;AAInCC,EAAAA,OAJmC;AAKnCC,EAAAA;AALmC,CAA9B,EAM0C;AAC/C,gCAAYF,KAAZ;AACA,QAAMG,KAAK,GAAGH,KAAK,CAACI,QAAN,EAAd;;AAEA,MAAI,CAACL,QAAL,EAAe;AACb;AACD;;AAED,QAAM;AAAEM,IAAAA;AAAF,MAAmBN,QAAzB;;AAEA,MAAIM,YAAY,CAACC,MAAb,KAAwB,CAA5B,EAA+B;AAC7B;AACD;;AAED,QAAMC,QAAQ,GAAGC,kBAASC,cAAT,CACd,kBADc,EAEfJ,YAAY,CAACC,MAFE,EAGf,CAHe,EAIf;AACEI,IAAAA,EAAE,EAAG,oBADP;AAEEZ,IAAAA;AAFF,GAJe,CAAjB;;AAUAS,EAAAA,QAAQ,CAACI,KAAT;AAEA,MAAIC,YAAJ;;AACA,MACEC,OAAO,CAACC,GAAR,CAAYC,wBAAZ,KAA0C,SAA1C,IACA,CAACF,OAAO,CAACC,GAAR,CAAYE,mCADb,IAEA,CAAC,4BAHH,EAIE;AACAJ,IAAAA,YAAY,GAAG,4DACZ,iBADY,EAEZ,6CAFY,EAGZ;AACP;AACA;AACA;AACA;AACA;AACA,CATmB,EAUbhB,UAVa,CAAf;AAYD;;AAED,QAAM,+BAAmBS,YAAnB,EAAiC;AACrCF,IAAAA,KADqC;AAErCI,IAAAA,QAFqC;AAGrCL,IAAAA,aAHqC;AAIrCe,IAAAA,cAAc,EAAEhB,OAAF,aAAEA,OAAF,uBAAEA,OAAO,CAAEgB;AAJY,GAAjC,CAAN;;AAOA,MAAIJ,OAAO,CAACC,GAAR,CAAYI,QAAZ,KAA0B,aAA9B,EAA4C;AAC1C;AACJ;AACA;AACI,UAAM,yCAAN;AACD;;AAED,MAAIN,YAAJ,EAAkB;AAChBA,IAAAA,YAAY;AACb;;AAEDL,EAAAA,QAAQ,CAACY,IAAT;AACD","sourcesContent":["import { processPageQueries } from \"../query\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { IQueryRunningContext } from \"../state-machines/query-running/types\"\nimport { assertStore } from \"../utils/assert-store\"\nimport {\n  showExperimentNoticeAfterTimeout,\n  CancelExperimentNoticeCallbackOrUndefined,\n} from \"../utils/show-experiment-notice\"\nimport { isCI } from \"gatsby-core-utils\"\nimport { processNodeManifests } from \"../utils/node-manifest\"\n\nconst ONE_MINUTE = 1 * 60 * 1000\n\nexport async function runPageQueries({\n  parentSpan,\n  queryIds,\n  store,\n  program,\n  graphqlRunner,\n}: Partial<IQueryRunningContext>): Promise<void> {\n  assertStore(store)\n  const state = store.getState()\n\n  if (!queryIds) {\n    return\n  }\n\n  const { pageQueryIds } = queryIds\n\n  if (pageQueryIds.length === 0) {\n    return\n  }\n\n  const activity = reporter.createProgress(\n    `run page queries`,\n    pageQueryIds.length,\n    0,\n    {\n      id: `page-query-running`,\n      parentSpan,\n    }\n  )\n\n  activity.start()\n\n  let cancelNotice: CancelExperimentNoticeCallbackOrUndefined\n  if (\n    process.env.gatsby_executing_command === `develop` &&\n    !process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND &&\n    !isCI()\n  ) {\n    cancelNotice = showExperimentNoticeAfterTimeout(\n      `Query On Demand`,\n      `https://gatsby.dev/query-on-demand-feedback`,\n      `which avoids running page queries in development until you visit a page â€” so a lot less upfront work. Here's how to try it:\n\nmodules.exports = {\n  flags: { QUERY_ON_DEMAND: true },\n  plugins: [...]\n}\n`,\n      ONE_MINUTE\n    )\n  }\n\n  await processPageQueries(pageQueryIds, {\n    state,\n    activity,\n    graphqlRunner,\n    graphqlTracing: program?.graphqlTracing,\n  })\n\n  if (process.env.NODE_ENV !== `development`) {\n    /**\n     * only process node manifests here when not in develop. for gatsby develop we process node manifests in src/query/query-watcher.ts everytime queries are re-run. Because we process node manifests in this location for gatsby build we have all the information needed to create the manifests. In query-watcher during gatsby build we might not have all information about created pages and queries.\n     */\n    await processNodeManifests()\n  }\n\n  if (cancelNotice) {\n    cancelNotice()\n  }\n\n  activity.done()\n}\n"],"file":"run-page-queries.js"}